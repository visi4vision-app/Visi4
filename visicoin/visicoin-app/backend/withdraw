app.post("/withdraw", verifyUser, async (req, res) => {
  const { amount, operator, phone } = req.body;
  const uid = req.user.uid;

  const userRef = db.collection("users").doc(uid);
  const snap = await userRef.get();

  if (!snap.exists)
    return res.status(404).json({ error: "Utilisateur introuvable" });

  const user = snap.data();

  if (!canWithdraw(user, amount))
    return res.status(403).json({ error: "Retrait refus√©" });

  await db.collection("withdrawals").add({
    uid,
    amount,
    operator,
    phone,
    status: "pending",
    createdAt: admin.firestore.FieldValue.serverTimestamp(),
  });

  await userRef.update({
    balance: user.balance - amount,
  });

  res.json({ success: true, message: "Retrait en attente" });
});
